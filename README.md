# OpenWRT ModemManager Enhanced

Enhanced ModemManager packages for OpenWRT with auto device path detection and improved LuCI interface.

## Packages

This repository contains two packages:

1. **modemmanager** - Core ModemManager protocol handler for OpenWRT
2. **luci-proto-modemmanager** - LuCI web interface for ModemManager

## Features & Enhancements

### üîß Auto Device Path Update

**Problem:** When OpenWRT reboots, USB device paths can change (e.g., from `/sys/.../usb2/2-1` to `/sys/.../usb2/2-2`), causing ModemManager to fail connecting because the old path is stored in `/etc/config/network`.

**Solution:** Automatic device path detection and update using ModemManager's device identifier.

#### How it works:

1. **First Connection:** 
   - Modem connects normally
   - Script stores `device-identifier` (unique hash) and `equipment-identifier` (IMEI) to UCI config

2. **After Reboot (path changed):**
   - Script detects old path is invalid
   - Searches all available modems via `mmcli -L`
   - Matches modem using stored identifiers
   - Auto-updates UCI config with new path
   - Connection proceeds normally

3. **Multi-Modem Support:**
   - Each interface tracks its own modem by identifier
   - No confusion between multiple modems
   - Correct modem always matched after path changes

**Files Modified:**
- `modemmanager/files/lib/netifd/proto/modemmanager.sh`
  - Added `mm_find_modem_by_identifier()` function
  - Added `mm_auto_update_device_path()` function
  - Integrated auto-update in `proto_modemmanager_setup()`

### üåê LuCI Interface Enhancement

**Added:** `Force connection` option in Advanced Settings

**What it does:**
- Automatically retry connection on registration or connection failures
- Prevents interface from blocking on errors
- Eliminates need for manual interface restart

**Files Modified:**
- `luci-proto-modemmanager/htdocs/luci-static/resources/protocol/modemmanager.js`
  - Added `force_connection` checkbox in Advanced tab
  - Includes helpful description for users

## Installation

```bash
# Copy packages to OpenWRT build system
cp -r modemmanager /path/to/openwrt/feeds/packages/net/
cp -r luci-proto-modemmanager /path/to/openwrt/feeds/luci/protocols/

# Build packages
cd /path/to/openwrt
./scripts/feeds update -a
./scripts/feeds install modemmanager luci-proto-modemmanager

# Compile
make package/modemmanager/compile
make package/luci-proto-modemmanager/compile
```

## Configuration Example

### Basic Configuration

```uci
config interface 'mm'
    option proto 'modemmanager'
    option device '/sys/devices/platform/soc/5310000.usb/usb2/2-1'
    option apn 'internet'
    option auth 'none'
    option iptype 'ipv4'
```

### With Auto-Reconnect

```uci
config interface 'mm'
    option proto 'modemmanager'
    option device '/sys/devices/platform/soc/5310000.usb/usb2/2-1'
    option apn 'internet'
    option auth 'none'
    option iptype 'ipv4'
    option force_connection '1'
```

### Multi-Modem Setup

```uci
# Modem 1
config interface 'modem1'
    option proto 'modemmanager'
    option device '/sys/devices/platform/soc/5310000.usb/usb2/2-1'
    option apn 'internet'
    option device_id '4e24b09759d5bc51e1509b5167ae6c7fdac157ad'
    option equipment_id '015184009652624'

# Modem 2
config interface 'modem2'
    option proto 'modemmanager'
    option device '/sys/devices/platform/soc/5310000.usb/usb2/2-2'
    option apn 'internet2'
    option device_id 'abc123def456789...'
    option equipment_id '987654321098765'
```

## Technical Details

### Device Identification

The script uses two identifiers to match modems:

1. **device-identifier** - Unique hash generated by ModemManager
   ```bash
   mmcli -m 0 -K | grep 'modem.generic.device-identifier'
   # Output: modem.generic.device-identifier: 4e24b09759d5bc51e1509b5167ae6c7fdac157ad
   ```

2. **equipment-identifier** - IMEI of the modem
   ```bash
   mmcli -m 0 -K | grep 'modem.generic.equipment-identifier'
   # Output: modem.generic.equipment-identifier: 015184009652624
   ```

### Auto-Update Flow

```
Interface startup
    ‚Üì
Try old device path
    ‚Üì
Path invalid? ‚Üí Search by device-identifier
    ‚Üì
Found? ‚Üí Get new physdev path
    ‚Üì
Update UCI: uci set network.mm.device='<new_path>'
            uci commit network
    ‚Üì
Continue connection with new path
```

## Testing

To test the auto device path update:

```bash
# 1. Check current modem info
mmcli -m 0 -K | grep -E 'device-identifier|equipment-identifier|physdev'

# 2. Reboot device
reboot

# 3. After reboot, check if path auto-updated
uci show network.mm
cat /var/log/messages | grep modemmanager
```

## Troubleshooting

### Debug Mode

Enable debug logging in LuCI:
- Go to Network ‚Üí Interfaces ‚Üí ModemManager Interface ‚Üí Edit
- Advanced Settings ‚Üí Log output level ‚Üí Debug

Or via UCI:
```bash
uci set network.mm.loglevel='DEBUG'
uci commit network
ifup mm
```

### Check ModemManager Status

```bash
# List all modems
mmcli -L

# Get modem details
mmcli -m 0

# Check logs
logread | grep -i modem
```

## Credits

Original ModemManager protocol: [OpenWRT ModemManager](https://github.com/openwrt/packages/tree/master/net/modemmanager)

Original LuCI interface: [OpenWRT LuCI](https://github.com/openwrt/luci)

## License

Same as OpenWRT packages (GPL-2.0)

## Changelog

### 2025-12-25
- Added auto device path detection and update functionality
- Added support for multi-modem configurations using device identifiers
- Added `force_connection` option to LuCI Advanced Settings
- Improved modem matching reliability using device-identifier and IMEI
