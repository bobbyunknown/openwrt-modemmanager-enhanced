name: Build ModemManager Packages

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release Tag'
        required: true
        default: 'v1.0.0'
      publish:
        description: 'Publish to Release?'
        type: boolean
        required: true
        default: true
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    permissions:
      contents: write
    name: Build ${{ matrix.arch }}-${{ matrix.branch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch:
          - openwrt-24.10
          - openwrt-25.12
        arch:
          - x86_64
          - i386_pentium-mmx
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_generic
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a9
          - arm_cortex-a7
          - mips_24kc
          - mipsel_74kc

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Build Packages
        uses: openwrt/gh-action-sdk@main
        continue-on-error: false
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.branch }}
          FEEDNAME: modemmanager_enhanced
          PACKAGES: libmbim libqmi modemmanager luci-proto-modemmanager
          INDEX: 1
          #V: s

      - name: Organize Artifacts
        run: |
          mkdir -p output
          branch="${{ matrix.branch }}"
          branch_suffix="${branch#openwrt-}"
          arch="${{ matrix.arch }}"
          
          if [ "${{ matrix.branch }}" = "openwrt-24.10" ]; then
            # Copy all .ipk packages
            find bin/packages -name "libmbim_*.ipk" -exec cp {} output/ \;
            find bin/packages -name "mbim-utils_*.ipk" -exec cp {} output/ \;
            find bin/packages -name "modemmanager_*.ipk" -exec cp {} output/ \;
            find bin/packages -name "luci-proto-modemmanager_*.ipk" -exec cp {} output/ \;
            
            # Rename with branch suffix
            (
              cd output
              for file in *.ipk; do
                if [ -f "$file" ]; then
                  base="${file%.ipk}"
                  base="${base/openwrt-/}"
                  mv "$file" "${base}-${branch_suffix}.ipk"
                fi
              done
            )
          fi
          
          if [ "${{ matrix.branch }}" = "openwrt-25.12" ]; then
            # Copy all .apk packages
            find bin/packages -name "libmbim-*.apk" -exec cp {} output/ \;
            find bin/packages -name "mbim-utils-*.apk" -exec cp {} output/ \;
            find bin/packages -name "modemmanager-*.apk" -exec cp {} output/ \;
            find bin/packages -name "luci-proto-modemmanager-*.apk" -exec cp {} output/ \;
            
            # Rename with branch suffix
            (
              cd output
              for file in *.apk; do
                if [ -f "$file" ]; then
                  base="${file%.apk}"
                  base="${base/openwrt-/}"
                  if echo "$base" | grep -q "_all$"; then
                    mv "$file" "${base}-${branch_suffix}.apk"
                  else
                    mv "$file" "${base}-${branch_suffix}-${arch}.apk"
                  fi
                fi
              done
            )
          fi
          
          echo "Files in output directory:"
          ls -lh output/

      - name: Upload Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: modemmanager-enhanced-${{ matrix.branch }}-${{ matrix.arch }}
          path: output/*
          if-no-files-found: error

  aggregate_packages:
    needs: build
    if: ${{ !cancelled() }}
    name: Aggregate All Packages
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: modemmanager-enhanced-*
          path: downloaded
          merge-multiple: true

      - name: List All Files
        run: ls -lh downloaded

      - name: Upload Combined Artifact
        uses: actions/upload-artifact@v4
        with:
          name: modemmanager-enhanced-all-packages
          path: downloaded/*
          if-no-files-found: error

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        if: ${{ inputs.publish == true && github.event_name == 'workflow_dispatch' }}
        with:
          tag_name: ${{ inputs.tag_name }}
          name: ModemManager Enhanced ${{ inputs.tag_name }}
          body: |
            # ModemManager Enhanced ${{ inputs.tag_name }}
            
            Enhanced ModemManager packages for OpenWRT with auto device path detection and improved LuCI interface.
            
            ## ‚ú® Features
            
            - **Auto Device Path Detection**: Automatically detects and updates modem device path after reboot
            - **Multi-Modem Support**: Supports multiple modems with unique identifier tracking
            - **Force Connection UI**: Added force_connection option in LuCI Advanced Settings
            - **Improved Reliability**: Uses ModemManager's device-identifier and IMEI for modem matching
            
            ## üì¶ Package Details
            
            - **libmbim**: MBIM protocol library (v1.32.0) - Required dependency
            - **mbim-utils**: Utilities for MBIM modems (mbimcli, mbim-network)
            - **modemmanager**: Core protocol handler with auto path detection
            - **luci-proto-modemmanager**: Enhanced LuCI web interface
            
            Available for:
            - OpenWRT 24.10 (Stable) - `.ipk` format
            - OpenWRT 25.12 (Latest) - `.apk` format
            
            ## üöÄ Installation
            
            ### OpenWRT 24.10 (Stable)
            ```
            # Upload all packages to router
            cd /tmp
            
            # Install in order (dependencies first)
            opkg install libmbim_*-openwrt-24.10.ipk
            opkg install mbim-utils_*-openwrt-24.10.ipk
            opkg install modemmanager_*-openwrt-24.10.ipk
            opkg install luci-proto-modemmanager_*-openwrt-24.10.ipk
            ```
            
            ### OpenWRT 25.12 (Latest)
            ```
            # Upload all packages to router
            cd /tmp
            
            # Install in order (dependencies first)
            apk add libmbim-*-openwrt-25.12.apk
            apk add mbim-utils-*-openwrt-25.12.apk
            apk add modemmanager-*-openwrt-25.12.apk
            apk add luci-proto-modemmanager-*-openwrt-25.12.apk
            ```
            
            ## üìñ Documentation
            
            Full documentation available at: https://github.com/${{ github.repository }}
            
            ## üêõ Bug Reports
            
            Report issues at: https://github.com/${{ github.repository }}/issues
          files: downloaded/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
